<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø¹Ø³ÙƒØ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap');
        
        body { font-family: 'Cairo', sans-serif; background-color: #f0f4f8; overflow-x: hidden; }
        
        /* Glassmorphism Styles */
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.6); }
        .glass-dark { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(12px); color: white; }
        
        .sidebar-link { transition: all 0.3s ease; border-right: 3px solid transparent; }
        .sidebar-link:hover, .sidebar-link.active { background: #e0e7ff; color: #4338ca; border-right-color: #4338ca; }
        
        .task-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        
        /* Subject Gradients */
        .grad-ar { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #7f1d1d; }
        .grad-bio { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #14532d; }
        .grad-chem { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e3a8a; }
        .grad-phys { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #78350f; }
        .grad-eng { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); color: #581c87; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen text-slate-800">

    <aside class="w-72 bg-white/80 backdrop-blur-md shadow-2xl z-50 flex flex-col hidden md:flex border-l border-slate-200">
        <div class="p-8 flex items-center gap-3">
            <div class="w-12 h-12 rounded-2xl bg-indigo-600 text-white flex items-center justify-center text-xl shadow-lg shadow-indigo-200">
                <i class="fas fa-brain"></i>
            </div>
            <div>
                <h1 class="font-black text-xl tracking-tight text-slate-800">Ø§Ù„Ù…Ø¹Ø³ÙƒØ± <span class="text-indigo-600"></span></h1>
                <p class="text-xs text-slate-500 font-bold">Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹Ø³ÙƒØ±Ø§Øª </p>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-2">
            <button onclick="router('dashboard')" id="nav-dashboard" class="sidebar-link active w-full flex items-center gap-4 px-6 py-4 rounded-xl font-bold text-slate-500">
                <i class="fas fa-home text-lg"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </button>
            <button onclick="router('schedule')" id="nav-schedule" class="sidebar-link w-full flex items-center gap-4 px-6 py-4 rounded-xl font-bold text-slate-500">
                <i class="fas fa-calendar-alt text-lg"></i> Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
            </button>
            <button onclick="router('backlog')" id="nav-backlog" class="sidebar-link w-full flex items-center gap-4 px-6 py-4 rounded-xl font-bold text-slate-500 relative">
                <i class="fas fa-layer-group text-lg"></i> Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…
                <span id="badge-backlog" class="absolute left-4 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="router('analytics')" id="nav-analytics" class="sidebar-link w-full flex items-center gap-4 px-6 py-4 rounded-xl font-bold text-slate-500">
                <i class="fas fa-chart-pie text-lg"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            </button>
        </nav>

        <div class="p-6">
            <button onclick="openModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl shadow-slate-300 hover:bg-slate-800 transition flex items-center justify-center gap-2">
                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-[#f8fafc]">
        
        <header class="h-20 glass flex items-center justify-between px-8 sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-2xl text-slate-600"><i class="fas fa-bars"></i></button>
                <h2 id="page-title" class="text-2xl font-bold text-slate-800">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-left hidden sm:block">
                    <p class="text-sm font-bold text-slate-800" id="current-date-display"></p>
                    <p class="text-xs text-indigo-500 font-bold" id="exam-countdown"></p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-200 border-2 border-white shadow-md overflow-hidden">
                    <img src="https://ui-avatars.com/api/?name=Hero&background=4f46e5&color=fff" alt="User">
                </div>
            </div>
        </header>

        <div id="app-view" class="flex-1 overflow-y-auto p-6 md:p-10 space-y-8 scroll-smooth">
            </div>

    </main>

    <div id="task-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl scale-100 transition-transform">
            <h3 class="text-xl font-bold mb-6" id="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <input type="hidden" id="task-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                    <input type="text" id="input-title" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-bold">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-500 mb-1">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                        <select id="input-subject" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold">
                            <option value="ar">Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="bio">Ø£Ø­ÙŠØ§Ø¡/Ø¬ÙŠÙˆ</option>
                            <option value="chem">ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
                            <option value="phys">ÙÙŠØ²ÙŠØ§Ø¡</option>
                            <option value="eng">Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-500 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="text" id="input-date" placeholder="1/25" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold">
                    </div>
                </div>
                <button onclick="saveTaskFromModal()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const TODAY = "1/17"; // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©)
        
        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙƒÙ…Ø§ Ø·Ù„Ø¨ØªÙ‡Ø§
        const initialDB = [
             // Ø§Ù„Ø¹Ø±Ø¨ÙŠ
            { id: 1, s: 'ar', t: 'Ø§Ù…ØªØ­Ø§Ù† ØªÙ‚ÙŠÙŠÙ…ÙŠ', d: '1/16', done: false },
            { id: 2, s: 'ar', t: 'Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰', d: '1/17', done: false },
            { id: 3, s: 'ar', t: 'ØªÙƒÙ…Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰', d: '1/18', done: false },
            { id: 4, s: 'ar', t: 'Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©', d: '1/19', done: false },
            { id: 5, s: 'ar', t: 'ØªÙƒÙ…Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©', d: '1/20', done: false },
            { id: 6, s: 'ar', t: 'Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©', d: '1/21', done: false },
            { id: 7, s: 'ar', t: 'ØªÙƒÙ…Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©', d: '1/22', done: false },
            { id: 8, s: 'ar', t: 'Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©', d: '1/23', done: false },
            { id: 9, s: 'ar', t: 'ØªÙƒÙ…Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©', d: '1/24', done: false },
            // Ø§Ù„Ø£Ø­ÙŠØ§Ø¡/Ø¬ÙŠÙˆ
            { id: 10, s: 'bio', t: 'Ø§Ù„Ø¯Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ø­Ø±ÙƒØ© (Ø´Ø±Ø­+Ø­Ù„)', d: '1/17', done: false },
            { id: 11, s: 'bio', t: 'Ø§Ù„Ù‡Ø±Ù…ÙˆÙ†Ø§Øª (Ø´Ø±Ø­+Ø­Ù„)', d: '1/19', done: false },
            { id: 12, s: 'bio', t: 'Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø´Ø§Ù…Ù„', d: '1/20', done: false, type: 'exam' },
            { id: 13, s: 'bio', t: 'Ø§Ù„ØªÙƒØ§Ø«Ø± Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†', d: '1/21', done: false },
            { id: 14, s: 'bio', t: 'Ø§Ù„ØªÙƒØ§Ø«Ø± ÙÙŠ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†', d: '1/23', done: false },
            { id: 15, s: 'bio', t: 'Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨ Ø§Ù„Ø¬ÙŠÙˆÙ„ÙˆØ¬ÙŠØ©', d: '1/25', done: false },
            { id: 16, s: 'bio', t: 'Ø§Ù„Ù…Ø¹Ø§Ø¯Ù† (Ø´Ø±Ø­+Ø­Ù„)', d: '1/27', done: false },
            { id: 17, s: 'bio', t: 'Ø­Ù„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø´Ø§Ù…Ù„Ø©', d: '1/29', done: false },
            // ÙƒÙŠÙ…ÙŠØ§Ø¡
            { id: 18, s: 'chem', t: 'Ù…Ø¹Ø³ÙƒØ± Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠØ©', d: '1/19', done: false },
            { id: 19, s: 'chem', t: 'Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ø¨ 4', d: '1/20', done: false, type: 'exam' },
            { id: 20, s: 'chem', t: 'Ù…Ø¹Ø³ÙƒØ± Ø§Ù„Ø§ØªØ²Ø§Ù†', d: '1/21', done: false },
            { id: 21, s: 'chem', t: 'Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ø¨ 3', d: '1/22', done: false, type: 'exam' },
            { id: 22, s: 'chem', t: 'Ù…Ø¹Ø³ÙƒØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„', d: '1/23', done: false },
            { id: 23, s: 'chem', t: 'Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ø¨ 2', d: '1/24', done: false, type: 'exam' },
            { id: 24, s: 'chem', t: 'Ù…Ø¹Ø³ÙƒØ± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ÙŠØ©', d: '1/26', done: false },
            { id: 25, s: 'chem', t: 'Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ø¨ 1', d: '1/27', done: false, type: 'exam' },
            { id: 26, s: 'chem', t: 'Ø¨Ø¯Ø§ÙŠØ© Ø¹Ø¶ÙˆÙŠØ©', d: '1/31', done: false },
            { id: 27, s: 'chem', t: 'Ø´Ø§Ù…Ù„ ÙƒÙŠÙ…ÙŠØ§Ø¡', d: '2/5', done: false, type: 'exam' },
            // ÙÙŠØ²ÙŠØ§Ø¡
            { id: 28, s: 'phys', t: 'Ù…Ø±Ø§Ø¬Ø¹Ø© 1 (Ø§ÙØªÙƒÙ‘Ø± Ø§Ù„Ù„ÙŠ ÙØ§Øª)', d: '1/25', done: false },
            { id: 29, s: 'phys', t: 'Ù…Ø±Ø§Ø¬Ø¹Ø© 2 (Ù…ÙØ§ØªÙŠØ­ ÙˆØªØ±ÙŠÙƒØ§Øª)', d: '1/28', done: false },
            { id: 30, s: 'phys', t: 'Ù…Ø±Ø§Ø¬Ø¹Ø© 3 (ØªØ±Ø¨ÙŠØ·Ø§Øª)', d: '1/30', done: false },
        ];
        
        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
        for(let i=25; i<=31; i++) initialDB.push({ id: 100+i, s: 'eng', t: `Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ`, d: `1/${i}`, done: false });
        for(let i=1; i<=11; i++) initialDB.push({ id: 200+i, s: 'eng', t: `Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ`, d: `2/${i}`, done: false });

        // State
        let tasks = JSON.parse(localStorage.getItem('proTasks')) || initialDB;
        let currentView = 'dashboard';
        let scheduleMode = 'week'; // 'month' or 'week'

        // --- CORE FUNCTIONS ---
        function save() {
            localStorage.setItem('proTasks', JSON.stringify(tasks));
            renderBadge();
        }

        function parseDate(dStr) {
            const [m, d] = dStr.split('/').map(Number);
            return new Date(2026, m-1, d);
        }

        // --- ROUTER & VIEWS ---
        function router(view) {
            currentView = view;
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active', 'bg-indigo-50', 'text-indigo-600'));
            document.getElementById(`nav-${view}`).classList.add('active', 'bg-indigo-50', 'text-indigo-600');
            
            const app = document.getElementById('app-view');
            const title = document.getElementById('page-title');
            
            app.innerHTML = ''; // Clear
            
            if (view === 'dashboard') renderDashboard(app, title);
            else if (view === 'schedule') renderSchedule(app, title);
            else if (view === 'backlog') renderBacklog(app, title);
            else if (view === 'analytics') renderAnalytics(app, title);
        }

        // 1. DASHBOARD VIEW
        function renderDashboard(container, title) {
            title.innerText = "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©";
            const todayTasks = tasks.filter(t => t.d === TODAY);
            const donePercent = Math.round((tasks.filter(t => t.done).length / tasks.length) * 100);

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-3xl p-8 text-white relative overflow-hidden shadow-xl">
                        <div class="relative z-10">
                            <h2 class="text-3xl font-bold mb-2">ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ! ğŸš€</h2>
                            <p class="text-indigo-100 mb-6">Ù„Ø¯ÙŠÙƒ <span class="font-bold text-white text-xl border-b-2 border-yellow-400 mx-1">${todayTasks.length}</span> Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…. Ø£Ù†Øª Ø£Ù‚ÙˆÙ‰ Ù…Ù…Ø§ ØªØªØ®ÙŠÙ„!</p>
                            <div class="w-full bg-white/20 h-3 rounded-full overflow-hidden backdrop-blur-sm">
                                <div class="bg-yellow-400 h-full transition-all duration-1000" style="width: ${donePercent}%"></div>
                            </div>
                            <p class="text-xs mt-2 font-bold opacity-80 text-left">${donePercent}% Ù…Ù† Ø§Ù„Ù…Ø¹Ø³ÙƒØ± Ù…ÙƒØªÙ…Ù„</p>
                        </div>
                        <i class="fas fa-trophy absolute -bottom-6 -left-6 text-9xl text-white opacity-10 rotate-12"></i>
                    </div>
                    
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center">
                        <div class="w-20 h-20 rounded-full border-4 border-indigo-100 flex items-center justify-center text-3xl font-bold text-indigo-600 mb-2">
                           ${todayTasks.filter(t=>t.done).length}/${todayTasks.length}
                        </div>
                        <p class="text-slate-500 font-bold">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…</p>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-slate-800">Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… (${TODAY})</h3>
                        <button onclick="router('schedule')" class="text-sm text-indigo-600 font-bold hover:underline">Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„</button>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        ${todayTasks.length ? todayTasks.map(t => createCardHTML(t)).join('') : '<div class="p-8 text-center bg-white rounded-2xl border border-dashed border-slate-300 text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ø±Ø§Ø­Ø©! â˜•</div>'}
                    </div>
                </div>
            `;
        }

        // 2. SCHEDULE VIEW (Week/Month + PDF)
        function renderSchedule(container, title) {
            title.innerText = "Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ";
            
            // Filters & Controls
            const controls = `
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div class="bg-white p-1 rounded-xl border border-slate-200 shadow-sm flex">
                        <button onclick="setScheduleMode('week')" class="px-6 py-2 rounded-lg font-bold text-sm transition ${scheduleMode === 'week' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                        <button onclick="setScheduleMode('month')" class="px-6 py-2 rounded-lg font-bold text-sm transition ${scheduleMode === 'month' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}">Ø´Ù‡Ø±ÙŠ</button>
                    </div>
                    <button onclick="downloadPDF()" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-sm hover:bg-slate-700 flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i> ØªØ­Ù…ÙŠÙ„ PDF
                    </button>
                </div>
            `;

            let contentHTML = '';
            
            // Sorting Tasks Chronologically
            const sortedTasks = [...tasks].sort((a,b) => parseDate(a.d) - parseDate(b.d));
            const grouped = sortedTasks.reduce((acc, t) => { (acc[t.d] = acc[t.d] || []).push(t); return acc; }, {});

            if(scheduleMode === 'month') {
                contentHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="schedule-content">`;
                for(const [date, dayTasks] of Object.entries(grouped)) {
                    contentHTML += `
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition break-inside-avoid">
                            <div class="flex justify-between items-center mb-3 border-b border-slate-50 pb-2">
                                <span class="font-bold text-indigo-700 bg-indigo-50 px-2 py-1 rounded text-sm">${date}</span>
                                <span class="text-xs text-slate-400 font-bold">${dayTasks.length} Ù…Ù‡Ø§Ù…</span>
                            </div>
                            <div class="space-y-2">
                                ${dayTasks.map(t => `
                                    <div class="text-xs p-2 rounded-lg ${getSubjectStyle(t.s)} font-bold flex justify-between items-center group cursor-pointer" onclick="openModal(${t.id})">
                                        <span class="${t.done ? 'line-through opacity-50' : ''} truncate">${t.t}</span>
                                        ${t.type==='exam' ? '<i class="fas fa-exclamation-circle text-red-500"></i>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                contentHTML += `</div>`;
            } else {
                // Weekly View (Just showing next 7 days from today for simplicity)
                const todayTime = parseDate(TODAY).getTime();
                const weekTasks = sortedTasks.filter(t => {
                    const tTime = parseDate(t.d).getTime();
                    return tTime >= todayTime && tTime <= todayTime + (7 * 86400000);
                });
                
                // Group again for week
                const weekGrouped = weekTasks.reduce((acc, t) => { (acc[t.d] = acc[t.d] || []).push(t); return acc; }, {});

                contentHTML = `<div class="space-y-6" id="schedule-content">`;
                for(const [date, dayTasks] of Object.entries(weekGrouped)) {
                    contentHTML += `
                        <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                            <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-calendar-day text-indigo-500"></i> ${date}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${dayTasks.map(t => createCardHTML(t)).join('')}
                            </div>
                        </div>
                    `;
                }
                contentHTML += `</div>`;
            }

            container.innerHTML = controls + contentHTML;
        }

        // 3. BACKLOG VIEW
        function renderBacklog(container, title) {
            title.innerText = " Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…";
            const todayTime = parseDate(TODAY).getTime();
            const backlogTasks = tasks.filter(t => !t.done && parseDate(t.d).getTime() < todayTime);

            container.innerHTML = `
                <div class="bg-red-50 border border-red-100 rounded-3xl p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <div class="bg-white p-4 rounded-full text-red-500 shadow-sm"><i class="fas fa-fire-alt text-2xl"></i></div>
                        <div>
                            <h3 class="font-bold text-red-900 text-lg">Ø§Ù„Ø­Ù‚ Ù†ÙØ³Ùƒ </h3>
                            <p class="text-red-700 text-sm">Ù„Ø¯ÙŠÙƒ <span class="font-black text-xl">${backlogTasks.length}</span> Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©. Ù„Ø§ ØªØ¤Ø¬Ù„ Ù…Ù‡Ù…Ù‡ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø§Ù‡!</p>
                        </div>
                    </div>
                    ${backlogTasks.length > 0 ? `
                    <button onclick="smartDistribute()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-red-200 transition flex items-center gap-2 transform hover:scale-105 active:scale-95">
                        <i class="fas fa-magic"></i>  ØªÙˆØ²ÙŠØ¹  ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù‚Ø±Ø¨ ÙˆÙ‚Øª ÙÙŠÙ‡ Ù…Ù‡Ø§Ù… Ø®ÙÙŠÙÙ‡
                    </button>` : ''}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${backlogTasks.length ? backlogTasks.map(t => createCardHTML(t, true)).join('') : 
                    `<div class="col-span-full text-center py-12">
                        <i class="fas fa-check-circle text-6xl text-green-200 mb-4 block"></i>
                        <span class="text-slate-400 font-bold"> Ø¹Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø´ Ù…ÙÙŠØ´ Ø§ÙŠ Ø­Ø§Ø¬Ù‡ Ù…ØªØ±Ø§ÙƒÙ…Ù‡ .</span>
                    </div>`}
                </div>
            `;
        }

        // 4. ANALYTICS VIEW
        function renderAnalytics(container, title) {
            title.innerText = "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡";
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-96 relative">
                        <h4 class="font-bold text-slate-700 mb-4">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙƒÙ„ÙŠØ©</h4>
                        <canvas id="chartPie"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-96 relative">
                        <h4 class="font-bold text-slate-700 mb-4">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©</h4>
                        <canvas id="chartBar"></canvas>
                    </div>
                </div>
            `;
            setTimeout(initCharts, 100);
        }

        // --- HELPER HTML GENERATORS ---
        function getSubjectStyle(code) {
            const styles = {
                ar: 'grad-ar', bio: 'grad-bio', chem: 'grad-chem', phys: 'grad-phys', eng: 'grad-eng'
            };
            return styles[code] || 'bg-slate-100 text-slate-600';
        }
        
        function getSubjectName(code) {
             const names = { ar: 'Ø¹Ø±Ø¨ÙŠ', bio: 'Ø£Ø­ÙŠØ§Ø¡', chem: 'ÙƒÙŠÙ…ÙŠØ§Ø¡', phys: 'ÙÙŠØ²ÙŠØ§Ø¡', eng: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ' };
             return names[code] || 'Ø¹Ø§Ù…';
        }

        function createCardHTML(t, isBacklog = false) {
            return `
                <div class="task-card bg-white p-4 rounded-2xl border ${t.done ? 'border-green-200 opacity-70' : 'border-slate-100'} shadow-sm relative group overflow-hidden">
                    <div class="flex justify-between items-start">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center font-bold text-lg shadow-inner ${getSubjectStyle(t.s)}">
                                ${getSubjectName(t.s)[0]}
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 ${t.done ? 'line-through text-slate-400' : ''}">${t.t}</h4>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 bg-slate-100 px-2 py-0.5 rounded">${getSubjectName(t.s)}</span>
                                    <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded"><i class="fas fa-clock"></i> ${t.d}</span>
                                    ${t.type === 'exam' ? '<span class="text-[10px] font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded">Ø§Ù…ØªØ­Ø§Ù†</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <input type="checkbox" onchange="toggleDone(${t.id})" ${t.done ? 'checked' : ''} class="w-6 h-6 accent-indigo-600 cursor-pointer rounded-lg">
                    </div>
                    
                    <div class="absolute bottom-2 left-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="openModal(${t.id})" class="text-xs bg-indigo-100 text-indigo-600 p-2 rounded-lg hover:bg-indigo-200"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteTask(${t.id})" class="text-xs bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS ---
        function setScheduleMode(mode) {
            scheduleMode = mode;
            router('schedule');
        }

        function toggleDone(id) {
            const task = tasks.find(t => t.id === id);
            task.done = !task.done;
            save();
            router(currentView); // Refresh
            
            if(task.done) {
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
                    didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
                });
                Toast.fire({ icon: 'success', title: 'Ø¹Ø§Ø´ ÙŠØ§ Ø¨Ø·Ù„! Ø§Ø³ØªÙ…Ø± ğŸ’ª' });
            }
        }

        function deleteTask(id) {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', text: "Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù‡Ù…Ø©", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#cbd5e1', confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    tasks = tasks.filter(t => t.id !== id);
                    save();
                    router(currentView);
                    Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù!', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            });
        }

        // --- MODAL LOGIC (ADD/EDIT) ---
        function openModal(id = null) {
            const modal = document.getElementById('task-modal');
            modal.classList.remove('hidden');
            
            if(id) {
                const task = tasks.find(t => t.id === id);
                document.getElementById('modal-title').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
                document.getElementById('task-id').value = task.id;
                document.getElementById('input-title').value = task.t;
                document.getElementById('input-subject').value = task.s;
                document.getElementById('input-date').value = task.d;
            } else {
                document.getElementById('modal-title').innerText = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                document.getElementById('task-id').value = '';
                document.getElementById('input-title').value = '';
                document.getElementById('input-date').value = TODAY;
            }
        }

        function closeModal() {
            document.getElementById('task-modal').classList.add('hidden');
        }

        function saveTaskFromModal() {
            const id = document.getElementById('task-id').value;
            const title = document.getElementById('input-title').value;
            const subj = document.getElementById('input-subject').value;
            const date = document.getElementById('input-date').value;

            if(!title || !date) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');

            if(id) {
                // Edit
                const task = tasks.find(t => t.id == id);
                task.t = title; task.s = subj; task.d = date;
            } else {
                // Add
                tasks.push({
                    id: Date.now(),
                    t: title, s: subj, d: date, done: false
                });
            }
            save();
            closeModal();
            router(currentView);
            Swal.fire('Ù…Ù…ØªØ§Ø²', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // --- SMART FEATURES ---
        function smartDistribute() {
            const todayTime = parseDate(TODAY).getTime();
            const backlog = tasks.filter(t => !t.done && parseDate(t.d).getTime() < todayTime);
            
            // Find candidates (next 10 days)
            const candidates = [];
            for(let i=1; i<=10; i++) {
                // Simple logic: Day number + i (needs better date handling for month rolling, simplified here)
                const d = parseInt(TODAY.split('/')[1]); 
                candidates.push(`1/${d+i}`);
            }

            backlog.forEach(t => {
                // Find least busy day
                let bestDay = candidates[0];
                let min = 99;
                candidates.forEach(day => {
                    const count = tasks.filter(x => x.d === day).length;
                    if(count < min) { min = count; bestDay = day; }
                });
                t.d = bestDay;
            });
            
            save();
            router('backlog');
            Swal.fire('ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹!', 'Ø§Ù„Ù…Ù‡Ù…Ù‡ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ù‡ Ø§ØªÙˆØ²Ø¹Ù†Øª Ø¹Ù†Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ø«Ø±Ø¨ ÙŠÙˆÙ… ÙÙÙŠÙ‡ Ø¹Ø¯Ø¯ Ù…Ù‡Ø§Ù… Ø§Ù‚Ù„', 'success');
        }

        function downloadPDF() {
            const element = document.getElementById('schedule-content');
            const opt = {
                margin: 1,
                filename: 'My_Study_Schedule.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function initCharts() {
            const done = tasks.filter(t => t.done).length;
            const total = tasks.length;

            new Chart(document.getElementById('chartPie'), {
                type: 'doughnut',
                data: {
                    labels: ['Ù…Ù†Ø¬Ø²', 'Ù…ØªØ¨Ù‚ÙŠ'],
                    datasets: [{ data: [done, total-done], backgroundColor: ['#4f46e5', '#e2e8f0'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const subKeys = ['ar', 'bio', 'chem', 'phys', 'eng'];
            const subData = subKeys.map(k => tasks.filter(t => t.s === k && t.done).length);
            
            new Chart(document.getElementById('chartBar'), {
                type: 'bar',
                data: {
                    labels: ['Ø¹Ø±Ø¨ÙŠ', 'Ø£Ø­ÙŠØ§Ø¡', 'ÙƒÙŠÙ…ÙŠØ§Ø¡', 'ÙÙŠØ²ÙŠØ§Ø¡', 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ'],
                    datasets: [{ label: 'Ù…Ù‡Ø§Ù… Ù…Ù†Ø¬Ø²Ø©', data: subData, backgroundColor: ['#fecaca', '#bbf7d0', '#bfdbfe', '#fde68a', '#e9d5ff'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderBadge() {
            const todayTime = parseDate(TODAY).getTime();
            const count = tasks.filter(t => !t.done && parseDate(t.d).getTime() < todayTime).length;
            const badge = document.getElementById('badge-backlog');
            if(count > 0) {
                badge.classList.remove('hidden');
                badge.innerText = count;
            } else {
                badge.classList.add('hidden');
            }
        }

        // --- INIT ---
       // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
const today = new Date();
const dateString = today.toLocaleDateString('ar-EG', options);
document.getElementById('current-date-display').innerText = `Ø§Ù„ÙŠÙˆÙ…: ${dateString}`;

// 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
// Ø¨Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ØªØ¨Ø¯Ø£ ÙŠÙˆÙ… 13 ÙŠÙˆÙ†ÙŠÙˆ 2026 (Ù…ÙˆØ¹Ø¯ ØªÙ‚Ø¯ÙŠØ±ÙŠ)
const examDate = new Date('June 13, 2026');
const timeDiff = examDate - today;

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ±Ù‚ Ù…Ù† Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© Ø¥Ù„Ù‰ Ø£ÙŠØ§Ù…
const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

if (daysLeft > 0) {
    document.getElementById('exam-countdown').innerText = `Ø¨Ø§Ù‚ÙŠ ${daysLeft} ÙŠÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª`;
} else if (daysLeft === 0) {
    document.getElementById('exam-countdown').innerText = `ØªØ¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…! Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚`;
} else {
    document.getElementById('exam-countdown').innerText = `Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø£Ùˆ Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„`;
}
        renderBadge();
        router('dashboard');

    </script>
</body>
</html>
